/** * (c) Author:    Woongkyu Jee, woong.jee.16@ucl.ac.uk, wldndrb1@gmail.com * Created:   02.06.2019 ~ * 	 * University College London, Department of Chemistry **/#include<stdio.h>#include<stdlib.h>#include<string.h>#include<gsl/gsl_eigen.h>#include"sp_cluster_system.h"#include<mpi.h>#include<assert.h>#include<time.h>#define MAIN_FALSE -1#define MAIN_TRUE   1void MatViewf( FILE* fp, gsl_matrix* m ){    for(int i=0;i<m->size1;i++)    {   for(int j=0;j<m->size2;j++)            fprintf(fp,"%s%lf\t",gsl_matrix_get(m,i,j)>0.?"+":"",gsl_matrix_get(m,i,j));        fprintf(fp,"\n");    }    return;}void VecViewf( FILE* fp, gsl_vector* v ){    for(int i=0;i<v->size;i++)        fprintf(fp,"%lf\t",gsl_vector_get(v,i));    fprintf(fp,"\n");    return;}void liner_sharp(){	for(int i=0;i<77;i++)	printf("#");	printf("\n");	return;}void liner_line(){	for(int i=0;i<77;i++)	printf("-");	printf("\n");	return;}int main( int argc, char* argv[] ){    FILE* xyz;    FILE* next_config;    FILE* cube;    int if_success = MAIN_FALSE;    double elapsed_time;    double opti_elapsed_time;    /// /// /// /// MPI Variables    int numtasks, rank;    /// /// /// ///     sp_cluster_system* sp_sys = NULL;    double grad_x, grad_y, grad_z;    /// Creat MPI Environment    MPI_Init(&argc,&argv);    MPI_Comm_rank(MPI_COMM_WORLD,&rank);    MPI_Comm_size(MPI_COMM_WORLD,&numtasks);    sp_sys = sp_cluster_system_init();  // init sp_lone pair system single centre    elapsed_time = -MPI_Wtime();    if(rank == 0)    {   	liner_sharp();        printf("\n");        printf(" Sp Lone pair involved Atomistic Model ( S L A M ) \n\n");        printf(" Author (c)     :   Woongkyu Jee\n");        printf(" Affiliation    :   Universitiy College London, Department of Chemistry\n");        printf(" Contact        :   woong.jee.16@ucl.ac.uk / wldndrb1@gmail.com\n");        printf(" Version        :   slam_v_1.3.5_opti.x   ( Lastest Update : 07. 02. 2020 )\n");	printf("\n");	liner_sharp();	printf("\n");        printf(" Initiating SLAM Calculation\n\n");        printf(" Making Integral Table ( Using Cubic Spline Interpolation Algorithm )\n\n");    }    MPI_Barrier(MPI_COMM_WORLD);    sp_cluster_system_get_spline_integral( sp_sys );    elapsed_time += MPI_Wtime();    if(rank == 0)    {        printf(" Table Set Up Wtime : %.6lf s\n\n",elapsed_time);	liner_sharp();        /* HERE PUT GENERAL INFO ABOUT THE CALCULATION */        printf("\n");	printf(" General Input Info\n");	printf("\n");		//printf(" COMING SOON\n");	printf(" Geometry\n");	printf("\n");	liner_line();	printf(" Type.     x           y           z      \n");	liner_line();	sp_cluster_support_print_xyz(sp_sys,0.,rank,numtasks);	liner_line();	printf("\n");	liner_sharp();    }    MPI_Barrier(MPI_COMM_WORLD);    //  END OF INITIATION        int opti_res = MAIN_FALSE;    opti_elapsed_time = -MPI_Wtime();    if_success = sp_cluster_system_call_bfgs_algorithm_mpi( sp_sys, 0.20 /*in Angs*/, atoi(argv[2]) , rank,numtasks);    opti_elapsed_time+= MPI_Wtime();    if( rank == 0 ) liner_sharp();    if( if_success == MAIN_FALSE )    {	if( rank == 0 )	{	printf("\n");		printf(" Optimiser Failed ...\n");		printf("\n");		printf(" SLAM may need more optimisation steps ...\n");	}    }    if(rank == 0)     {        xyz = fopen(argv[1],"w");        next_config = fopen("geo.txt.next","w");        sp_cluster_system_write_xyz(sp_sys,xyz,argv[1]);        sp_cluster_system_get_next_config_mpi(sp_sys,next_config);        fclose(xyz);        fclose(next_config);        // density test        // if argv[3] contains the name of the cube file, then write cube file        if( argv[3] != NULL )        {   cube = fopen(argv[3],"w");            sp_cluster_system_get_density( sp_sys, 0.188973, cube );            fclose(cube);        }        // density test        printf("\n");        printf(" Optimisation Wtime : %.6lf s\n", opti_elapsed_time ); 	printf("\n");	if( if_success != MAIN_FALSE )	{			time_t t = time(NULL); 		struct tm tm = *localtime(&t);  		printf(" Date		:	%d-%02d-%02d %02d:%02d:%02d\n", tm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday, tm.tm_hour, tm.tm_min, tm.tm_sec);		printf("\n");		printf(" output xyz 	:	%s\n",argv[1]);		if( argv[3] != NULL )			printf(" output cube	:	%s\n",argv[3]);		printf(" next config	:	%s\n","geo.txt.next");		printf("\n");	}	liner_sharp();    }       MPI_Barrier(MPI_COMM_WORLD);    sp_cluster_system_free_spline_integral( sp_sys );    sp_cluster_system_detach(sp_sys);    MPI_Finalize();    return 0;}